<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist Admissional</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0e1014; color:#fff; font-family:Segoe UI; padding:40px;}
.card{background:#161a22;padding:25px;border-radius:12px;max-width:900px;margin:auto;}
input{padding:8px;margin-right:10px;background:#222631;border:none;color:#fff;border-radius:6px;}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;background:#5c8dff;color:#fff;}
.section{margin-top:20px;color:#5c8dff;font-size:13px;}
ul{list-style:none;padding:0;}
li{padding:6px 0;}
.completed{text-decoration:line-through;color:#777;}
.progress-bar{height:6px;background:#222631;border-radius:10px;margin:15px 0;}
.progress{height:100%;width:0%;background:#5c8dff;}
</style>
</head>

<body>
<div class="card">
<h2>Checklist Admissional</h2>

<input type="text" id="matricula" placeholder="Matrícula">
<input type="text" id="nome" placeholder="Nome">
<button id="btnCarregar">Carregar / Criar</button>

<div class="progress-bar">
<div class="progress" id="progress"></div>
</div>
<div id="stats"></div>

<div id="checklist"></div>
</div>

<script>

const SUPABASE_URL = "https://gqnazdvxvfvuakuaqwnz.supabase.co";
const SUPABASE_KEY = "sb_publishable_Zs9RE_TW74gPk_mTwiWGMg_ICRRMek0";

const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let employeeId = null;
let documentos = [];

document.getElementById("btnCarregar").addEventListener("click", carregarOuCriar);

async function carregarOuCriar() {

    const matricula = document.getElementById("matricula").value.trim();
    const nome = document.getElementById("nome").value.trim();

    if (!matricula || !nome) {
        alert("Informe matrícula e nome.");
        return;
    }

    const { data: emp, error } = await client
        .from('employees')
        .select('*')
        .eq('matricula', matricula);

    if (error) {
        console.error(error);
        alert("Erro ao consultar funcionário.");
        return;
    }

    if (emp.length === 0) {

        const { data: novo, error: errNovo } = await client
            .from('employees')
            .insert([{ matricula, nome }])
            .select();

        if (errNovo) {
            console.error(errNovo);
            alert("Erro ao criar funcionário.");
            return;
        }

        employeeId = novo[0].id;
        await criarChecklistInicial();

    } else {
        employeeId = emp[0].id;
        document.getElementById("nome").value = emp[0].nome;
    }

    await carregarChecklist();
}

async function criarChecklistInicial() {

    const { data: docs, error } = await client
        .from('documents')
        .select('id');

    if (error) {
        console.error(error);
        return;
    }

    const inserts = docs.map(doc => ({
        employee_id: employeeId,
        document_id: doc.id,
        entregue: false
    }));

    await client.from('employee_documents').insert(inserts);
}

async function carregarChecklist() {

    const { data, error } = await client
        .from('employee_documents')
        .select(`
            id,
            entregue,
            documents (nome, categoria, subcategoria)
        `)
        .eq('employee_id', employeeId);

    if (error) {
        console.error(error);
        return;
    }

    documentos = data;
    render();
}

function render() {

    const container = document.getElementById("checklist");
    container.innerHTML = "";

    documentos.forEach(doc => {

        const li = document.createElement("li");

        if (doc.entregue) li.classList.add("completed");

        li.innerHTML = `
            <input type="checkbox" ${doc.entregue ? "checked" : ""}
            onchange="toggle('${doc.id}', ${doc.entregue})">
            ${doc.documents.nome}
        `;

        container.appendChild(li);
    });

    atualizarProgresso();
}

async function toggle(id, status) {

    await client
        .from('employee_documents')
        .update({ entregue: !status })
        .eq('id', id);

    await carregarChecklist();
}

function atualizarProgresso() {

    const total = documentos.length;
    const concluidos = documentos.filter(d => d.entregue).length;
    const perc = total === 0 ? 0 : (concluidos / total) * 100;

    document.getElementById("progress").style.width = perc + "%";
    document.getElementById("stats").innerText =
        `${concluidos} de ${total} documentos concluídos`;
}

</script>
</body>
</html>
